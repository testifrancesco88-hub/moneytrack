<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MoneyTrack">
  <meta name="theme-color" content="#111827">
  <title>MoneyTrack - Pro</title>

  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTW9uZXlUcmFjayIsInNob3J0X25hbWUiOiJNb25leVRyYWNrIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMTE4MjciLCJ0aGVtZV9jb2xvciI6IiMxMTE4MjcifQ==">

  <style>
    :root {
      --primary: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --dark: #111827;
      --gray-bg: #f3f4f6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--dark);
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
      overscroll-behavior: none;
    }

    #app {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: white;
    }

    /* Header & Navigation */
    .header {
      background: var(--dark);
      color: white;
      padding: env(safe-area-inset-top) 16px 16px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-green { background: var(--success); }
    .header-blue  { background: var(--primary); }
    .header-gray  { background: #374151; }

    .logo-container { text-align: center; padding: 30px 20px; background: var(--dark); }
    .logo-icon {
      width: 70px; height: 70px; margin: 0 auto 12px;
      background: linear-gradient(135deg, #06b6d4, #3b82f6);
      border-radius: 18px; display: flex; align-items: center; justify-content: center;
    }
    .logo-text {
      font-size: 24px; font-weight: 800;
      background: linear-gradient(135deg, #06b6d4, #3b82f6);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; background: white; }

    /* List Items */
    .list-item {
      padding: 18px 20px;
      border-bottom: 1px solid #f0f0f0;
      display: flex; align-items: center; justify-content: space-between;
      transition: background 0.1s;
    }
    .list-item:active { background: #f9fafb; }

    /* Buttons */
    .btn {
      padding: 14px; border: none; border-radius: 12px;
      font-size: 15px; font-weight: 700; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.1s, opacity 0.2s;
    }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: var(--success); color: white; }
    .btn-danger  { background: var(--danger); color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-outline { background: #e5e7eb; color: #374151; }
    .btn:disabled { opacity: 0.4; }

    /* Keypad & Display */
    .display-box { padding: 15px; text-align: center; position: relative; }
    .display-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-bottom: 4px; }
    .display-value { font-size: 32px; font-weight: 800; font-variant-numeric: tabular-nums; }

    .keypad {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 10px; padding: 15px; background: #f9fafb;
    }
    .key {
      height: 60px; border: none; border-radius: 14px;
      font-size: 22px; font-weight: 600; background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); color: var(--dark);
    }
    .key:active { background: #e2e8f0; transform: scale(0.95); }
    .key.action { background: #fee2e2; color: var(--danger); }

    .mode-selector { display: flex; background: #f3f4f6; padding: 4px; gap: 4px; }
    .mode-btn {
      flex: 1; padding: 10px; border: none; border-radius: 8px;
      font-weight: 700; font-size: 12px; background: transparent; color: #6b7280;
    }
    .mode-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    .field-selector { display: flex; gap: 8px; padding: 10px; justify-content: center; background: #4b5563; }
    .field-btn {
      padding: 8px 16px; border: none; border-radius: 20px;
      background: rgba(255,255,255,0.2); color: white; font-size: 11px; font-weight: 600;
    }
    .field-btn.active { background: white; color: #374151; }

    /* Stats Specific */
    .stats-card { background: white; margin: 12px; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden; }
    
    @media (max-height: 700px) {
      .key { height: 50px; font-size: 20px; }
      .logo-container { padding: 15px; }
      .display-value { font-size: 26px; }
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <script>
    // Configurazione
    const banks = ['Euronet', 'Chianti Banca', 'CCB', 'CRV', 'Medio Banca', 'MPS', 'MPS PG', 'Intesa S.Paolo'];
    const employees = ['Francesco', 'Silvia', 'Dorota', 'William', 'Stefania', 'Filomena', 'Valeria', 'Flavio', 'Ciro', 'Alessandro', 'Ida'];

    let state = {
      screen: 'banks',
      selectedBank: '',
      selectedEmployee: '',
      amount: '0',
      rejected: '0',
      mode: 'manual',
      inputField: 'amount',
      totals: {},
      lastMachineValue: {},
      machineConfirmed: {},
      lastOp: null,
      logs: []
    };

    const STORAGE_KEY = "moneytrack_v1_save";

    // Utility
    function formatEUR(n) {
      return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(n || 0);
    }

    function safeParse(v) {
      const s = (v ?? "0").toString();
      const val = parseFloat(s);
      return isNaN(val) ? 0 : val;
    }

    // Persistenza
    function save() {
      const data = {
        totals: state.totals,
        lastMachineValue: state.lastMachineValue,
        machineConfirmed: state.machineConfirmed,
        logs: state.logs
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function load() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        state.totals = parsed.totals || {};
        state.lastMachineValue = parsed.lastMachineValue || {};
        state.machineConfirmed = parsed.machineConfirmed || {};
        state.logs = parsed.logs || [];
      }
    }

    // Logic
    function computeStats() {
      const startOfDay = new Date().setHours(0, 0, 0, 0);
      const dailyLogs = state.logs.filter(l => new Date(l.ts).getTime() >= startOfDay);
      
      const stats = { total: 0, byBank: {}, byEmp: {} };
      dailyLogs.forEach(l => {
        stats.total += l.delta;
        stats.byBank[l.bank] = (stats.byBank[l.bank] || 0) + l.delta;
        stats.byEmp[l.emp] = (stats.byEmp[l.emp] || 0) + l.delta;
      });
      return stats;
    }

    function shareReport() {
      const s = computeStats();
      let msg = `ðŸ“Š *REPORT MONEYTRACK - ${new Date().toLocaleDateString()}*\n\n`;
      msg += `ðŸ’° Totale: ${formatEUR(s.total)}\n\n`;
      msg += `*Dettaglio Banche:*\n`;
      Object.entries(s.byBank).forEach(([b, v]) => msg += `â€¢ ${b}: ${formatEUR(v)}\n`);
      
      if (navigator.share) {
        navigator.share({ title: 'Report MoneyTrack', text: msg });
      } else {
        alert("Copiato negli appunti (simulazione)");
        console.log(msg);
      }
    }

    // Handlers UI
    function addDigit(d) {
      let current = state[state.inputField];
      if (current === '0') state[state.inputField] = d;
      else if (current.length < 9) state[state.inputField] += d;
      render();
    }

    function addDecimal() {
      if (!state[state.inputField].includes('.')) {
        state[state.inputField] += '.';
        render();
      }
    }

    function deleteDigit() {
      let current = state[state.inputField];
      state[state.inputField] = current.length > 1 ? current.slice(0, -1) : '0';
      render();
    }

    function confirmMachine() {
      const val = safeParse(state.amount);
      if (val <= 0) return;

      const bank = state.selectedBank;
      const prev = state.lastMachineValue[bank] || 0;
      const delta = val - prev;
      const key = `${bank}|||${state.selectedEmployee}`;

      // Aggiorna
      state.totals[key] = (state.totals[key] || 0) + delta;
      state.lastMachineValue[bank] = val;
      state.machineConfirmed[bank] = true;
      
      state.logs.push({ ts: new Date().toISOString(), bank, emp: state.selectedEmployee, delta, type: 'machine' });
      
      state.amount = '0';
      state.inputField = 'rejected';
      save();
      render();
    }

    function addToTotal() {
      const bank = state.selectedBank;
      const emp = state.selectedEmployee;
      const key = `${bank}|||${emp}`;
      let delta = 0;

      if (state.mode === 'manual') {
        delta = safeParse(state.amount);
      } else {
        delta = safeParse(state.rejected);
      }

      state.totals[key] = (state.totals[key] || 0) + delta;
      state.logs.push({ ts: new Date().toISOString(), bank, emp, delta, type: 'plus' });
      
      // Reset input
      state.amount = '0';
      state.rejected = '0';
      state.inputField = 'amount';
      save();
      render();
    }

    function resetEmployee() {
      if (confirm("Azzerare il totale di questo dipendente?")) {
        const key = `${state.selectedBank}|||${state.selectedEmployee}`;
        state.totals[key] = 0;
        save();
        render();
      }
    }

    function undo() {
      if (state.logs.length === 0) return;
      const last = state.logs.pop();
      const key = `${last.bank}|||${last.emp}`;
      state.totals[key] -= last.delta;
      if (last.type === 'machine') {
          // Nota: il ripristino del valore macchina precedente richiederebbe log piÃ¹ complessi
          // ma per semplicitÃ  resettiamo la conferma
          state.machineConfirmed[last.bank] = false;
      }
      save();
      render();
    }

    // Render Engine
    function render() {
      const app = document.getElementById('app');

      if (state.screen === 'banks') {
        app.innerHTML = `
          <div class="header">
            <span style="font-weight:700">MoneyTrack Pro</span>
            <div style="display:flex; gap:10px">
               <button class="btn" style="background:#374151; padding:8px" onclick="state.screen='stats'; render()">ðŸ“Š</button>
            </div>
          </div>
          <div class="logo-container">
            <div class="logo-icon">ðŸ’°</div>
            <div class="logo-text">MoneyTrack</div>
          </div>
          <div class="header header-green" style="padding:10px 16px; font-size:13px">SELEZIONA BANCA</div>
          <div class="content">
            ${banks.map(b => `
              <div class="list-item" onclick="state.selectedBank='${b}'; state.screen='employees'; render()">
                <span style="font-weight:600">${b}</span>
                <span style="color:#9ca3af">â€º</span>
              </div>
            `).join('')}
          </div>
        `;
      } 
      
      else if (state.screen === 'employees') {
        app.innerHTML = `
          <div class="header header-blue">
            <button class="btn" style="background:transparent; color:white; font-size:20px" onclick="state.screen='banks'; render()">â€¹</button>
            <span style="font-weight:700">${state.selectedBank}</span>
            <div style="width:30px"></div>
          </div>
          <div class="content">
            ${employees.map(e => {
              const total = state.totals[`${state.selectedBank}|||${e}`] || 0;
              return `
                <div class="list-item" onclick="state.selectedEmployee='${e}'; state.screen='counter'; render()">
                  <span style="font-weight:500">${e}</span>
                  <span style="font-weight:700; color:var(--success)">${formatEUR(total)}</span>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      else if (state.screen === 'counter') {
        const key = `${state.selectedBank}|||${state.selectedEmployee}`;
        const total = state.totals[key] || 0;
        const lastM = state.lastMachineValue[state.selectedBank] || 0;
        const isConfirmed = state.machineConfirmed[state.selectedBank];

        app.innerHTML = `
          <div class="header header-gray">
            <button class="btn" style="background:transparent; color:white; font-size:20px" onclick="state.screen='employees'; render()">â€¹</button>
            <div style="text-align:center">
              <div style="font-size:10px; opacity:0.8">${state.selectedBank}</div>
              <div style="font-weight:700">${state.selectedEmployee}</div>
            </div>
            <div style="width:30px"></div>
          </div>

          <div class="mode-selector">
            <button class="mode-btn ${state.mode==='manual'?'active':''}" onclick="state.mode='manual'; render()">MANUALE</button>
            <button class="mode-btn ${state.mode==='auto'?'active':''}" onclick="state.mode='auto'; render()">AUTO DIFF</button>
          </div>

          <div class="display-box" style="background:var(--primary); color:white">
            <div class="display-label">Totale Dipendente</div>
            <div class="display-value">${formatEUR(total)}</div>
          </div>

          ${state.mode === 'auto' ? `
            <div class="field-selector">
              <button class="field-btn ${state.inputField==='amount'?'active':''}" onclick="state.inputField='amount'; render()">Macchina</button>
              <button class="field-btn ${state.inputField==='rejected'?'active':''}" onclick="state.inputField='rejected'; render()">Scartate</button>
            </div>
            <div style="background:#1f2937; color:white; padding:8px; font-size:11px; text-align:center">
              Ultimo Valore Macchina: <b>${formatEUR(lastM)}</b> 
              <span style="margin-left:10px; color:${isConfirmed?'#4ade80':'#fbbf24'}">${isConfirmed?'âœ“ OK':'âš  Confermare'}</span>
            </div>
          ` : ''}

          <div class="display-box" style="background:#f9fafb; border-bottom:1px solid #e5e7eb">
            <div class="display-label" style="color:#6b7280">${state.inputField === 'amount' ? 'Inserimento Importo' : 'Inserimento Scartate'}</div>
            <div class="display-value" style="color:var(--dark)">â‚¬ ${state[state.inputField]}</div>
          </div>

          <div class="keypad">
            ${[1,2,3,4,5,6,7,8,9].map(n => `<button class="key" onclick="addDigit('${n}')">${n}</button>`).join('')}
            <button class="key" onclick="addDecimal()">.</button>
            <button class="key" onclick="addDigit('0')">0</button>
            <button class="key action" onclick="deleteDigit()">âŒ«</button>
          </div>

          <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; padding:15px">
            <button class="btn btn-outline" onclick="undo()">UNDO</button>
            ${state.mode === 'auto' && state.inputField === 'amount' ? 
              `<button class="btn btn-primary" style="background:#0ea5e9" onclick="confirmMachine()">CONF. MACCHINA</button>` :
              `<button class="btn btn-primary" onclick="addToTotal()">OK / AGGIUNGI</button>`
            }
            <button class="btn btn-danger" onclick="resetEmployee()">RESET</button>
          </div>
          
          ${state.mode === 'auto' ? `<button class="btn" style="margin:0 15px 15px; background:#6b7280; color:white" onclick="state.lastMachineValue['${state.selectedBank}']=0; state.machineConfirmed['${state.selectedBank}']=false; render()">AZZERA MACCHINA</button>` : ''}
        `;
      }

      else if (state.screen === 'stats') {
        const s = computeStats();
        app.innerHTML = `
          <div class="header" style="background:var(--dark)">
            <button class="btn" style="background:transparent; color:white; font-size:20px" onclick="state.screen='banks'; render()">â€¹</button>
            <span style="font-weight:700">Statistiche Oggi</span>
            <button class="btn" style="background:transparent; color:white" onclick="shareReport()">ðŸ“¤</button>
          </div>
          <div class="content" style="background:#f3f4f6">
            <div class="display-box" style="background:var(--dark); color:white; margin:12px; border-radius:12px">
              <div class="display-label">Incasso Totale</div>
              <div class="display-value">${formatEUR(s.total)}</div>
            </div>
            
            <div style="padding:0 12px; font-weight:700; font-size:13px; color:#6b7280">PER BANCA</div>
            <div class="stats-card">
              ${Object.entries(s.byBank).length ? Object.entries(s.byBank).map(([b, v]) => `
                <div class="list-item">
                  <span>${b}</span>
                  <span style="font-weight:700">${formatEUR(v)}</span>
                </div>
              `).join('') : '<div class="list-item">Nessun dato oggi</div>'}
            </div>

            <div style="padding:0 12px; font-weight:700; font-size:13px; color:#6b7280">PER DIPENDENTE</div>
            <div class="stats-card">
              ${Object.entries(s.byEmp).map(([e, v]) => `
                <div class="list-item">
                  <span>${e}</span>
                  <span style="font-weight:700; color:var(--primary)">${formatEUR(v)}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
    }

    // Init
    load();
    render();

    // Prevent zoom mobile
    document.addEventListener('touchstart', (e) => {
      if (e.touches.length > 1) e.preventDefault();
    }, { passive: false });
  </script>
</body>
</html>
