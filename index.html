<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="MoneyTrack" />
  <meta name="theme-color" content="#111827" />
  <title>MoneyTrack - Pro</title>

  <!-- ‚úÖ PWA Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="./assets/icons/icon-180x180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./assets/icons/favicon-16x16.png">

  <!-- ‚úÖ Manifest (inline ok, ma meglio un file vero quando vuoi) -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTW9uZXlUcmFjayIsInNob3J0X25hbWUiOiJNb25leVRyYWNrIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMTE4MjciLCJ0aGVtZV9jb2xvciI6IiMxMTE4MjcifQ==">

  <!-- ‚úÖ jsPDF per export PDF -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --primary:#2563eb;
      --success:#16a34a;
      --danger:#dc2626;
      --dark:#111827;
      --gray-bg:#f3f4f6;
      --slate:#374151;
      --purple:#7c3aed;
      --cyan:#0ea5e9;
    }

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:var(--dark);
      overflow:hidden;
      position:fixed;
      width:100%;
      height:100%;
      overscroll-behavior:none;
    }
    #app{width:100%;height:100%;display:flex;flex-direction:column;background:white;}

    /* ‚úÖ Splash overlay */
    #splash{
      position:fixed; inset:0;
      background:linear-gradient(180deg, #0b1220, #111827);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
      transition:opacity .35s ease, transform .35s ease;
    }
    #splash.hidden{
      opacity:0;
      transform:scale(1.02);
      pointer-events:none;
    }
    .splash-card{display:flex; flex-direction:column; align-items:center; gap:14px;}
    .splash-logo{
      width:112px; height:112px;
      border-radius:26px;
      background:rgba(255,255,255,0.08);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      padding:10px;
    }
    .splash-logo img{
      width:100%; height:100%;
      object-fit:cover;
      transform:scale(1.16); /* ‚úÖ pi√π aria, testo pi√π leggibile */
      display:block;
    }
    .splash-title{
      font-weight:900;
      font-size:22px;
      background:linear-gradient(135deg,#06b6d4,#3b82f6);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      letter-spacing:.2px;
    }
    .splash-sub{
      color:rgba(255,255,255,.55);
      font-size:12px;
      font-weight:800;
      letter-spacing:1px;
      text-transform:uppercase;
    }

    .header{
      background:var(--dark);
      color:white;
      padding:env(safe-area-inset-top) 16px 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index:10;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .header-green{background:var(--success);}
    .header-blue{background:var(--primary);}
    .header-gray{background:var(--slate);}

    .content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;background:white;}

    /* ‚úÖ Header app-style iOS */
    .header-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:120px;
    }
    .header-logo{
      width:26px;
      height:26px;
      border-radius:8px;
      background:rgba(255,255,255,0.10);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:2px;
    }
    .header-logo img{
      width:100%;
      height:100%;
      object-fit:cover;
      transform:scale(1.16); /* ‚úÖ pi√π aria ma senza cornice */
      display:block;
    }
    .header-title{
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:180px;
    }

    .logo-container{text-align:center;padding:26px 20px;background:var(--dark);}

    /* ‚úÖ Riquadro logo home: pi√π grande + pi√π aria */
    .logo-icon{
      width:124px;height:124px;margin:0 auto 12px;
      border-radius:28px;
      background:rgba(255,255,255,0.07);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      box-shadow:0 10px 25px rgba(0,0,0,0.25);
      padding:12px;
    }
    .logo-img{
      width:100%;
      height:100%;
      object-fit:cover;
      transform:scale(1.16); /* ‚úÖ pi√π aria, testo ‚ÄúMoneyTrack‚Äù pi√π leggibile */
      display:block;
    }
    .logo-text{
      font-size:24px;font-weight:900;
      background:linear-gradient(135deg,#06b6d4,#3b82f6);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }

    .list-item{
      padding:18px 20px;
      border-bottom:1px solid #f0f0f0;
      display:flex;align-items:center;justify-content:space-between;
      transition:background 0.1s;
      cursor:pointer;
      gap:12px;
    }
    .list-item:active{background:#f9fafb;}

    .list-left{display:flex; align-items:center; gap:10px; min-width:0;}
    .list-name{font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

    .list-actions{display:flex; align-items:center; gap:10px; flex-shrink:0;}
    .mini-btn{
      border:none;
      background:#e5e7eb;
      color:#374151;
      font-weight:900;
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
    }
    .mini-btn:active{transform:scale(.96);}
    .mini-btn.blue{background:#dbeafe;color:#1d4ed8;}
    .mini-btn.gray{background:#e5e7eb;color:#374151;}

    .btn{
      padding:14px;border:none;border-radius:12px;
      font-size:15px;font-weight:800;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:transform 0.1s, opacity 0.2s;
      user-select:none;
    }
    .btn:active{transform:scale(0.96);}
    .btn-primary{background:var(--success);color:white;}
    .btn-danger{background:var(--danger);color:white;}
    .btn-outline{background:#e5e7eb;color:#374151;}
    .btn:disabled{opacity:0.4;cursor:not-allowed;transform:none!important;}

    .display-box{padding:15px;text-align:center;position:relative;}
    .display-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;opacity:0.8;margin-bottom:4px;}
    .display-value{font-size:32px;font-weight:900;font-variant-numeric:tabular-nums;}

    .mode-selector{display:flex;background:#f3f4f6;padding:4px;gap:4px;}
    .mode-btn{
      flex:1;padding:10px;border:none;border-radius:8px;
      font-weight:900;font-size:12px;background:transparent;color:#6b7280;
      cursor:pointer;
    }
    .mode-btn.active{background:white;color:var(--primary);box-shadow:0 2px 4px rgba(0,0,0,0.1);}

    .field-selector{display:flex;gap:8px;padding:10px;justify-content:center;background:#4b5563;}
    .field-btn{
      padding:8px 16px;border:none;border-radius:20px;
      background:rgba(255,255,255,0.2);color:white;font-size:11px;font-weight:900;
      cursor:pointer;
    }
    .field-btn.active{background:white;color:#374151;}

    .keypad{
      display:grid;grid-template-columns:repeat(3,1fr);
      gap:10px;padding:15px;background:#f9fafb;
    }
    .key{
      height:60px;border:none;border-radius:14px;
      font-size:22px;font-weight:900;background:white;
      box-shadow:0 2px 4px rgba(0,0,0,0.05);
      color:var(--dark);
      cursor:pointer;
      transition:transform .1s, background .1s, opacity .2s;
      user-select:none;
    }
    .key:active{background:#e2e8f0;transform:scale(0.95);}
    .key.action{background:#fee2e2;color:var(--danger);}

    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;
      font-size:11px;font-weight:900;
    }

    .info-card{
      margin:20px;padding:26px 20px;
      background:var(--dark);color:white;
      border-radius:20px;text-align:center;
      box-shadow:0 10px 25px rgba(0,0,0,0.2);
    }
    .dev-badge{
      display:inline-block;padding:6px 15px;
      background:rgba(255,255,255,0.1);border-radius:30px;
      font-size:12px;font-weight:900;color:#06b6d4;margin-bottom:15px;
    }

    /* Responsive automatico per altezza */
    @media (max-height: 720px){
      .logo-container{padding:18px 15px;}
      .logo-icon{width:112px;height:112px;border-radius:26px;padding:10px;}
      .keypad{gap:8px;padding:12px;}
      .key{height:50px;font-size:20px;border-radius:12px;}
      .btn{padding:12px;font-size:14px;}
      .display-box{padding:12px;}
      .display-value{font-size:26px;}
      .header{padding-bottom:12px;}
    }
    @media (max-height: 640px){
      .logo-icon{width:104px;height:104px;border-radius:24px;padding:10px;}
      .key{height:44px;font-size:18px;}
      .display-value{font-size:24px;}
      .btn{padding:10px;font-size:13px;}
    }
  </style>
</head>

<body>
  <!-- ‚úÖ Splash Screen -->
  <div id="splash">
    <div class="splash-card">
      <div class="splash-logo">
        <img src="./assets/moneytrack-logo.png" alt="MoneyTrack">
      </div>
      <div class="splash-title">MoneyTrack</div>
      <div class="splash-sub">Loading‚Ä¶</div>
    </div>
  </div>

  <div id="app"></div>

  <script>
    // ‚úÖ Percorsi (GitHub Pages safe)
    const LOGO_SRC = "./assets/moneytrack-logo.png";

    const banks = ['Euronet','Chianti Banca','CCB','CRV','Medio Banca','MPS','MPS PG','Intesa S.Paolo'];
    const employees = ['Francesco','Silvia','Dorota','William','Stefania','Filomena','Valeria','Flavio','Ciro','Alessandro','Ida'];

    const STORAGE_KEY = "moneytrack_pro_v3";

    let state = {
      screen: 'banks',
      selectedBank: '',
      selectedEmployee: '',
      amount: '0',
      rejected: '0',
      mode: 'manual',
      inputField: 'amount',
      totals: {},
      lastMachineValue: {},
      machineConfirmed: {},
      lastOp: null,
      logs: []
    };

    // ===== HAPTIC (micro feedback) =====
    function haptic(type = "light"){
      // iOS Safari spesso non vibra; Android/PWA s√¨.
      if(!("vibrate" in navigator)) return;
      try{
        const map = {
          light: 10,
          medium: 18,
          heavy: 28,
          success: [10, 20, 10],
          error: [30, 30, 30],
          tick: 6
        };
        navigator.vibrate(map[type] ?? 10);
      }catch(e){}
    }

    function getKey(bank, emp){ return `${bank}|||${emp}`; }

    function formatEUR(n){
      return new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' }).format(Number(n)||0);
    }

    function safeParse(v){
      const s = (v ?? "0").toString();
      if (s === "." || s === "") return 0;
      if (s.endsWith(".")) return parseFloat(s.slice(0,-1)) || 0;
      const val = parseFloat(s);
      return isNaN(val) ? 0 : val;
    }

    function save(){
      const data = {
        totals: state.totals,
        lastMachineValue: state.lastMachineValue,
        machineConfirmed: state.machineConfirmed,
        logs: state.logs,
        lastOp: state.lastOp
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        state.totals = parsed.totals || {};
        state.lastMachineValue = parsed.lastMachineValue || {};
        state.machineConfirmed = parsed.machineConfirmed || {};
        state.logs = parsed.logs || [];
        state.lastOp = parsed.lastOp || null;
      }catch(e){
        state.totals = {};
        state.lastMachineValue = {};
        state.machineConfirmed = {};
        state.logs = [];
        state.lastOp = null;
      }
    }

    function pushLog(delta, kind){
      state.logs = state.logs || [];
      state.logs.push({
        ts: new Date().toISOString(),
        bank: state.selectedBank,
        emp: state.selectedEmployee,
        delta: Number(delta) || 0,
        kind
      });
    }

    function startOfTodayLocal(){
      const d = new Date();
      d.setHours(0,0,0,0);
      return d.getTime();
    }

    function computeTodayStats(){
      const start = startOfTodayLocal();
      let totalToday = 0;
      const byBank = {};
      const byEmp = {};

      for(const e of (state.logs||[])){
        const t = new Date(e.ts).getTime();
        if(isNaN(t) || t < start) continue;
        const delta = Number(e.delta) || 0;
        totalToday += delta;
        byBank[e.bank] = (byBank[e.bank] || 0) + delta;
        byEmp[e.emp] = (byEmp[e.emp] || 0) + delta;
      }

      let topEmp = null;
      let topVal = -Infinity;
      for(const [emp,val] of Object.entries(byEmp)){
        if(val > topVal){ topVal = val; topEmp = emp; }
      }
      return { totalToday, byBank, byEmp, topEmp, topVal: topVal === -Infinity ? 0 : topVal };
    }

    // ===== VALORE INIZIALE (manuale) =====
    function setInitialForEmployee(emp){
      const key = getKey(state.selectedBank, emp);
      const current = Number(state.totals[key] || 0);

      const raw = prompt(
        `Valore iniziale per ${emp} (Banca: ${state.selectedBank})\n` +
        `Attuale: ${formatEUR(current)}\n\n` +
        `Inserisci nuovo totale (es. 123.45):`,
        (current || 0).toFixed(2)
      );
      if(raw === null) return;

      const next = safeParse(raw);
      const delta = next - current;

      state.totals[key] = next;

      // Logga la differenza oggi (cos√¨ stats/export tornano)
      state.selectedEmployee = emp;
      pushLog(delta, "initial");

      state.lastOp = {
        key,
        delta,
        bank: state.selectedBank,
        prevMachine: state.lastMachineValue[state.selectedBank] || 0,
        type: 'initial'
      };

      save();
      haptic("success");
      render();
    }

    // ===== Export CSV/PDF =====
    function getTodayDateStr(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function buildTodayReport(){
      const s = computeTodayStats();
      const start = startOfTodayLocal();
      const rowsLogs = (state.logs || []).filter(e => {
        const t = new Date(e.ts).getTime();
        return !isNaN(t) && t >= start;
      });

      // per dipendente: somma oggi
      const byEmp = {};
      for(const e of rowsLogs){
        byEmp[e.emp] = (byEmp[e.emp] || 0) + (Number(e.delta) || 0);
      }

      return { stats: s, rowsLogs, byEmp };
    }

    function downloadBlob(filename, mime, content){
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 4000);
    }

    function exportTodayCSV(){
      const dateStr = getTodayDateStr();
      const rep = buildTodayReport();

      // CSV semplice (IT), separatore ;
      let csv = "";
      csv += `MoneyTrack Pro;Report Giornaliero;${dateStr}\n`;
      csv += `Totale Giornaliero;${rep.stats.totalToday.toFixed(2)}\n\n`;

      csv += `Totale per banca (oggi)\n`;
      csv += `Banca;Totale\n`;
      Object.entries(rep.stats.byBank)
        .sort((a,b)=>b[1]-a[1])
        .forEach(([bank,val])=>{
          csv += `${bank};${(Number(val)||0).toFixed(2)}\n`;
        });

      csv += `\nTotale per dipendente (oggi)\n`;
      csv += `Dipendente;Totale\n`;
      Object.entries(rep.byEmp)
        .sort((a,b)=>b[1]-a[1])
        .forEach(([emp,val])=>{
          csv += `${emp};${(Number(val)||0).toFixed(2)}\n`;
        });

      csv += `\nMovimenti (oggi)\n`;
      csv += `Ora;Banca;Dipendente;Tipo;Delta\n`;
      rep.rowsLogs.forEach(e=>{
        const t = new Date(e.ts);
        const hh = String(t.getHours()).padStart(2,'0');
        const mi = String(t.getMinutes()).padStart(2,'0');
        const ss = String(t.getSeconds()).padStart(2,'0');
        csv += `${hh}:${mi}:${ss};${e.bank};${e.emp};${e.kind};${(Number(e.delta)||0).toFixed(2)}\n`;
      });

      downloadBlob(`moneytrack_${dateStr}.csv`, "text/csv;charset=utf-8", csv);
      haptic("success");
    }

    function exportTodayPDF(){
      const dateStr = getTodayDateStr();
      const rep = buildTodayReport();

      // jsPDF (caricato via CDN)
      const { jsPDF } = (window.jspdf || {});
      if(!jsPDF){
        alert("jsPDF non √® stato caricato. Controlla connessione/CDN.");
        haptic("error");
        return;
      }

      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const pageW = doc.internal.pageSize.getWidth();
      const margin = 40;
      let y = 50;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text("MoneyTrack Pro ‚Äî Report Giornaliero", margin, y);
      y += 22;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);
      doc.text(`Data: ${dateStr}`, margin, y);
      y += 18;

      doc.setFont("helvetica", "bold");
      doc.text(`Totale giornaliero: ${formatEUR(rep.stats.totalToday)}`, margin, y);
      y += 26;

      // Top employee
      doc.setFont("helvetica", "bold");
      doc.text("Chi ha contato di pi√π", margin, y);
      y += 16;
      doc.setFont("helvetica", "normal");
      const topText = rep.stats.topEmp ? `${rep.stats.topEmp} ‚Äî ${formatEUR(rep.stats.topVal)}` : "Nessun movimento oggi";
      doc.text(topText, margin, y);
      y += 26;

      // Totale per banca
      doc.setFont("helvetica", "bold");
      doc.text("Totale per banca (oggi)", margin, y);
      y += 16;

      doc.setFont("helvetica", "normal");
      const banksSorted = Object.entries(rep.stats.byBank).sort((a,b)=>b[1]-a[1]);
      if(banksSorted.length === 0){
        doc.text("Nessun dato.", margin, y);
        y += 18;
      } else {
        for(const [bank,val] of banksSorted){
          doc.text(`${bank}: ${formatEUR(val)}`, margin, y);
          y += 16;
          if(y > 780){ doc.addPage(); y = 50; }
        }
      }

      y += 10;

      // Totale per dipendente
      doc.setFont("helvetica", "bold");
      doc.text("Totale per dipendente (oggi)", margin, y);
      y += 16;

      doc.setFont("helvetica", "normal");
      const empSorted = Object.entries(rep.byEmp).sort((a,b)=>b[1]-a[1]);
      if(empSorted.length === 0){
        doc.text("Nessun dato.", margin, y);
        y += 18;
      } else {
        for(const [emp,val] of empSorted){
          doc.text(`${emp}: ${formatEUR(val)}`, margin, y);
          y += 16;
          if(y > 780){ doc.addPage(); y = 50; }
        }
      }

      doc.save(`moneytrack_${dateStr}.pdf`);
      haptic("success");
    }

    // ===== keypad =====
    function addDigit(d){
      haptic("tick");
      const f = state.inputField;
      let cur = state[f];
      if(cur === '0') state[f] = d;
      else if(cur.length < 10) state[f] = cur + d;
      render();
    }
    function addDecimal(){
      haptic("tick");
      const f = state.inputField;
      if(!state[f].includes('.')) state[f] += '.';
      render();
    }
    function deleteDigit(){
      haptic("light");
      const f = state.inputField;
      let cur = state[f];
      state[f] = (cur.length > 1) ? cur.slice(0,-1) : '0';
      if(state[f] === '-') state[f] = '0';
      render();
    }
    function clearInput(){
      haptic("light");
      state[state.inputField] = '0';
      render();
    }

    function setMode(mode){
      haptic("light");
      state.mode = mode;
      state.amount = '0';
      state.rejected = '0';
      state.inputField = 'amount';
      render();
    }
    function setInputField(field){
      haptic("light");
      state.inputField = field;
      render();
    }

    function confirmMachineValue(){
      if(state.mode !== 'auto') return;

      const key = getKey(state.selectedBank, state.selectedEmployee);
      const currentTotal = state.totals[key] || 0;

      const currentMachineValue = safeParse(state.amount);
      if(currentMachineValue <= 0){ haptic("error"); return; }

      const lastValue = state.lastMachineValue[state.selectedBank] || 0;
      const delta = currentMachineValue - lastValue;

      state.totals[key] = currentTotal + delta;

      state.lastOp = {
        key,
        delta,
        bank: state.selectedBank,
        prevMachine: lastValue,
        newMachine: currentMachineValue,
        type: 'machine'
      };

      state.lastMachineValue[state.selectedBank] = currentMachineValue;
      state.machineConfirmed[state.selectedBank] = true;

      pushLog(delta, "machine");

      state.amount = '0';
      state.rejected = '0';
      state.inputField = 'rejected';

      save();
      haptic("success");
      render();
    }

    function addToTotal(){
      const key = getKey(state.selectedBank, state.selectedEmployee);
      const currentTotal = state.totals[key] || 0;
      let add = 0;

      if(state.mode === 'manual'){
        add = safeParse(state.amount);
        if(add === 0){ haptic("error"); return; }

        state.lastOp = {
          key,
          delta: add,
          bank: state.selectedBank,
          prevMachine: state.lastMachineValue[state.selectedBank] || 0,
          type: 'manual'
        };
      } else {
        if(state.machineConfirmed[state.selectedBank] !== true){ haptic("error"); return; }

        const lastValue = state.lastMachineValue[state.selectedBank] || 0;
        const rejectedAmount = safeParse(state.rejected);

        if(state.inputField === 'rejected'){
          add = rejectedAmount;
          if(add === 0){ haptic("error"); return; }

          state.lastOp = {
            key,
            delta: add,
            bank: state.selectedBank,
            prevMachine: lastValue,
            type: 'rejected'
          };
        } else {
          const currentMachineValue = safeParse(state.amount);
          add = (currentMachineValue - lastValue) + rejectedAmount;
          if(add === 0){ haptic("error"); return; }

          state.lastOp = {
            key,
            delta: add,
            bank: state.selectedBank,
            prevMachine: lastValue,
            newMachine: currentMachineValue,
            type: 'mixed'
          };

          state.lastMachineValue[state.selectedBank] = currentMachineValue;
          state.machineConfirmed[state.selectedBank] = true;
        }
      }

      state.totals[key] = currentTotal + add;
      pushLog(add, state.mode === 'manual' ? "manual" : "ok");

      state.amount = '0';
      state.rejected = '0';
      state.inputField = 'amount';

      save();
      haptic("success");
      render();
    }

    function undoLast(){
      const op = state.lastOp;
      if(!op || !op.key){ haptic("error"); return; }

      const cur = state.totals[op.key] || 0;
      state.totals[op.key] = cur - (op.delta || 0);

      if(op.bank && op.prevMachine !== undefined){
        state.lastMachineValue[op.bank] = op.prevMachine || 0;
      }

      if(state.logs && state.logs.length){
        const last = state.logs[state.logs.length - 1];
        const same = last && last.bank === op.bank && last.emp && op.key === getKey(last.bank, last.emp);
        if(same) state.logs.pop();
      }

      state.lastOp = null;
      save();
      haptic("light");
      render();
    }

    function resetTotal(){
      const key = getKey(state.selectedBank, state.selectedEmployee);
      if(!confirm("Reset totale dipendente?")) return;
      state.totals[key] = 0;
      state.amount = '0';
      state.rejected = '0';
      state.lastOp = null;
      save();
      haptic("heavy");
      render();
    }

    function resetMachine(){
      if(!confirm("Reset selezionatrice per questa banca?")) return;
      state.lastMachineValue[state.selectedBank] = 0;
      state.machineConfirmed[state.selectedBank] = false;
      state.amount = '0';
      state.rejected = '0';
      state.inputField = 'amount';
      state.lastOp = null;
      save();
      haptic("heavy");
      render();
    }

    // ===== UI helpers =====
    function headerHTML(rightButtonsHTML, backHTML = '', titleOverride = 'MoneyTrack Pro'){
      return `
        <div class="header">
          <div class="header-left">
            ${backHTML || ''}
            <div class="header-logo"><img src="${LOGO_SRC}" alt="MT"></div>
            <div class="header-title">${titleOverride}</div>
          </div>
          <div style="display:flex; gap:10px">${rightButtonsHTML || ''}</div>
        </div>
      `;
    }

    function go(screen){
      haptic("light");
      state.screen = screen;
      render();
    }

    // ===== Render =====
    function render(){
      const app = document.getElementById('app');

      if(state.screen === 'banks'){
        app.innerHTML = `
          ${headerHTML(`
            <button class="btn" style="background:#374151; padding:8px; width:40px" onclick="go('stats')">üìä</button>
            <button class="btn" style="background:#374151; padding:8px; width:40px" onclick="go('info')">‚ÑπÔ∏è</button>
          `, '', 'MoneyTrack Pro')}

          <div class="logo-container">
            <div class="logo-icon">
              <img class="logo-img" src="${LOGO_SRC}" alt="MoneyTrack logo">
            </div>
            <div class="logo-text">MoneyTrack</div>
          </div>

          <div class="header header-green" style="padding:10px 16px; font-size:13px">
            SELEZIONA BANCA
          </div>

          <div class="content">
            ${banks.map(b => `
              <div class="list-item" onclick="state.selectedBank='${b}'; go('employees')">
                <span style="font-weight:900">${b}</span>
                <span style="color:#9ca3af">‚Ä∫</span>
              </div>
            `).join('')}
          </div>
        `;
        return;
      }

      if(state.screen === 'info'){
        app.innerHTML = `
          ${headerHTML('', `<button class="btn" style="background:transparent; color:white; font-size:20px" onclick="go('banks')">‚Äπ</button>`, 'Info')}

          <div class="content" style="background:var(--gray-bg)">
            <div class="info-card">
              <!-- ‚úÖ stesso crop + aria del logo -->
              <div class="logo-icon" style="margin:0 auto 18px;">
                <img class="logo-img" src="${LOGO_SRC}" alt="MoneyTrack logo">
              </div>

              <div class="dev-badge">DEVELOPER</div>
              <h1 style="font-size:28px; letter-spacing:1px; margin-bottom:5px">TESTI FRANCESCO</h1>
              <p style="opacity:0.6; font-size:14px">Software Engineer & Design</p>

              <div style="margin-top:26px; padding-top:18px; border-top:1px solid rgba(255,255,255,0.1); font-size:12px; opacity:0.4">
                MoneyTrack Pro v1.4.0<br>¬© 2024 Tutti i diritti riservati
              </div>
            </div>
          </div>
        `;
        return;
      }

      if(state.screen === 'stats'){
        const s = computeTodayStats();
        const topText = s.topEmp ? `${s.topEmp} ‚Äî ${formatEUR(s.topVal)}` : "Nessun movimento oggi";

        const rows = Object.entries(s.byBank)
          .sort((a,b)=>b[1]-a[1])
          .map(([bank,val]) => `
            <div class="list-item" style="cursor:default">
              <span style="font-weight:900">${bank}</span>
              <span style="font-weight:900; color:var(--success)">${formatEUR(val)}</span>
            </div>
          `).join('');

        app.innerHTML = `
          ${headerHTML(
            `
              <button class="btn" style="background:#374151; padding:8px; width:40px" onclick="exportTodayCSV()">CSV</button>
              <button class="btn" style="background:#374151; padding:8px; width:40px" onclick="exportTodayPDF()">PDF</button>
            `,
            `<button class="btn" style="background:transparent; color:white; font-size:20px" onclick="go('banks')">‚Äπ</button>`,
            'Statistiche'
          )}

          <div class="content" style="background:#fff">
            <div class="display-box" style="background:var(--dark); color:white">
              <div class="display-label">Totale giornaliero</div>
              <div class="display-value">${formatEUR(s.totalToday)}</div>
            </div>

            <div class="display-box" style="background:var(--purple); color:white">
              <div class="display-label">Chi ha contato di pi√π üëÄ</div>
              <div style="font-size:18px; font-weight:900">${topText}</div>
            </div>

            <div style="padding:12px 16px; font-weight:900; color:var(--dark); background:#fff">
              Totale per banca (oggi)
            </div>

            ${rows || `<div style="padding:16px; color:#6b7280">Nessun dato per oggi.</div>`}

            <div style="padding:16px;">
              <div style="color:#6b7280; font-size:12px; font-weight:800;">
                Export: include Totale per banca, Totale per dipendente e movimenti di oggi.
              </div>
            </div>
          </div>
        `;
        return;
      }

      if(state.screen === 'employees'){
        app.innerHTML = `
          <div class="header header-blue">
            <div class="header-left">
              <button class="btn" style="background:transparent; color:white; font-size:20px" onclick="go('banks')">‚Äπ</button>
              <div class="header-logo"><img src="${LOGO_SRC}" alt="MT"></div>
              <div class="header-title">${state.selectedBank}</div>
            </div>
            <div style="width:40px"></div>
          </div>

          <div class="content">
            ${employees.map(e => {
              const key = getKey(state.selectedBank, e);
              const total = state.totals[key] || 0;
              return `
                <div class="list-item" onclick="state.selectedEmployee='${e}'; state.screen='counter'; state.amount='0'; state.rejected='0'; state.inputField='amount'; render(); haptic('light');">
                  <div class="list-left">
                    <div class="list-name">${e}</div>
                  </div>

                  <div class="list-actions">
                    <div style="font-weight:900; color:var(--success)">${formatEUR(total)}</div>

                    <!-- ‚úÖ Valore iniziale -->
                    <button class="mini-btn blue" onclick="event.stopPropagation(); setInitialForEmployee('${e}')">‚úé</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        return;
      }

      if(state.screen === 'counter'){
        const key = getKey(state.selectedBank, state.selectedEmployee);
        const total = state.totals[key] || 0;

        const lastValue = state.lastMachineValue[state.selectedBank] || 0;
        const amountVal = safeParse(state.amount);
        const rejectedVal = safeParse(state.rejected);

        const okEnabled = (state.mode === 'manual') || (state.machineConfirmed[state.selectedBank] === true);

        const showConfirmMachine =
          state.mode === 'auto' &&
          state.inputField === 'amount' &&
          (amountVal > 0) &&
          (amountVal !== lastValue);

        const diff = (state.mode === 'auto') ? (amountVal - lastValue) : 0;
        const calc = (state.mode === 'auto') ? (diff + rejectedVal) : 0;

        app.innerHTML = `
          <div class="header header-gray">
            <div class="header-left">
              <button class="btn" style="background:transparent; color:white; font-size:20px" onclick="go('employees')">‚Äπ</button>
              <div class="header-logo"><img src="${LOGO_SRC}" alt="MT"></div>
              <div class="header-title">${state.selectedEmployee}</div>
            </div>
            <div style="width:40px"></div>
          </div>

          <div class="mode-selector">
            <button class="mode-btn ${state.mode==='manual' ? 'active':''}" onclick="setMode('manual')">MANUALE</button>
            <button class="mode-btn ${state.mode==='auto' ? 'active':''}" onclick="setMode('auto')">AUTO DIFF</button>
          </div>

          <div class="content">
            <div class="display-box" style="background:var(--primary); color:white">
              <div class="display-label">Tot. dipendente</div>
              <div class="display-value">${formatEUR(total)}</div>
            </div>

            <!-- ‚úÖ Imposta valore iniziale anche da qui -->
            <div style="padding:0 15px 10px;">
              <button class="btn btn-outline" style="width:100%;" onclick="setInitialForEmployee('${state.selectedEmployee}')">
                Imposta valore iniziale
              </button>
            </div>

            ${state.mode === 'auto' ? `
              <div style="background:#4b5563; color:white; padding:10px 12px; text-align:center;">
                <div style="font-size:12px; font-weight:900;">
                  Selezionatrice (ultimo): <span style="opacity:.95">${formatEUR(lastValue)}</span>
                </div>
                <div style="margin-top:6px; font-size:11px; font-weight:900; color:${state.machineConfirmed[state.selectedBank] ? '#86efac' : '#fbbf24'};">
                  ${state.machineConfirmed[state.selectedBank] ? '‚úî Valore macchina confermato' : '‚ö† Conferma il valore macchina prima di OK'}
                </div>
              </div>

              <div class="field-selector">
                <button class="field-btn ${state.inputField==='amount'?'active':''}" onclick="setInputField('amount')">Valore Macchina</button>
                <button class="field-btn ${state.inputField==='rejected'?'active':''}" onclick="setInputField('rejected')">Scartate</button>
              </div>
            ` : ''}

            <div class="display-box" style="background:#f9fafb">
              <div class="display-label" style="color:#6b7280">
                ${state.mode === 'manual'
                  ? 'Inserimento'
                  : (state.inputField === 'amount' ? 'Valore macchina (attuale)' : 'Scartate')}
              </div>

              <div class="display-value" style="color:var(--dark)">
                ‚Ç¨ ${state.inputField === 'amount' ? state.amount : state.rejected}
              </div>

              ${state.mode === 'auto' && state.inputField === 'amount' && (state.amount !== '0' || state.rejected !== '0') ? `
                <div style="margin-top:8px; font-size:12px; font-weight:900;">
                  <span class="pill" style="background:#fde68a; color:#92400e">Diff: ${formatEUR(diff)}</span>
                  ${rejectedVal ? `<span class="pill" style="background:#fecaca; color:#991b1b; margin-left:8px">+ Scart: ${formatEUR(rejectedVal)}</span>` : ''}
                  <span class="pill" style="background:#bbf7d0; color:#065f46; margin-left:8px">= ${formatEUR(calc)}</span>
                </div>
              ` : ''}
            </div>

            ${showConfirmMachine ? `
              <div style="padding:0 15px 10px;">
                <button class="btn" style="width:100%; background:var(--cyan); color:white" onclick="confirmMachineValue()">
                  ‚úî CONFERMA VALORE MACCHINA
                </button>
              </div>
            ` : ''}

            <div class="keypad">
              ${[1,2,3,4,5,6,7,8,9].map(n => `<button class="key" onclick="addDigit('${n}')">${n}</button>`).join('')}
              <button class="key" onclick="addDecimal()">.</button>
              <button class="key" onclick="addDigit('0')">0</button>
              <button class="key action" onclick="deleteDigit()">‚å´</button>
            </div>

            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; padding:15px; background:#fff;">
              <button class="btn btn-outline" onclick="undoLast()">UNDO</button>
              <button class="btn btn-outline" onclick="clearInput()">CLEAR</button>
              <button class="btn btn-primary" ${okEnabled ? '' : 'disabled'} onclick="${okEnabled ? 'addToTotal()' : ''}">OK</button>
              <button class="btn btn-danger" onclick="resetTotal()">RESET</button>
            </div>

            ${state.mode === 'auto' ? `
              <div style="padding:0 15px 15px;">
                <button class="btn btn-outline" style="width:100%; background:var(--purple); color:white" onclick="resetMachine()">
                  RESET SELEZIONATRICE
                </button>
              </div>
            ` : ''}
          </div>
        `;
        return;
      }
    }

    // init
    load();
    render();

    // ‚úÖ Splash: 2 secondi poi fade out
    window.addEventListener('load', () => {
      const splash = document.getElementById('splash');
      setTimeout(() => {
        splash.classList.add('hidden');
        setTimeout(() => splash.remove(), 450);
      }, 2000);
    });

    // Previene lo zoom su double tap
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event){
      const now = Date.now();
      if(now - lastTouchEnd <= 300) event.preventDefault();
      lastTouchEnd = now;
    }, false);
  </script>
</body>
</html>
