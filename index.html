<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MoneyTrack">
  <meta name="theme-color" content="#111827">
  <title>MoneyTrack - Pro</title>

  <!-- ‚úÖ PWA Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="./assets/icons/icon-180x180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./assets/icons/favicon-16x16.png">

  <!-- ‚úÖ Manifest inline (ok anche cos√¨) -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTW9uZXlUcmFjayIsInNob3J0X25hbWUiOiJNb25leVRyYWNrIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMTE4MjciLCJ0aGVtZV9jb2xvciI6IiMxMTE4MjcifQ==">

  <style>
    :root{
      --primary:#2563eb;
      --success:#16a34a;
      --danger:#dc2626;
      --dark:#111827;
      --gray-bg:#f3f4f6;
      --slate:#374151;
      --purple:#7c3aed;
      --cyan:#0ea5e9;

      /* ‚úÖ Logo tuning */
      --logoBox: 112px;    /* pi√π grande = pi√π leggibile */
      --logoRadius: 26px;
      --logoZoom: 1.12;    /* meno zoom = si legge ‚ÄúMoneyTrack‚Äù */
      --logoPad: 10px;     /* aria attorno */
    }

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:var(--dark);
      overflow:hidden;
      position:fixed;
      width:100%;
      height:100%;
      overscroll-behavior:none;
    }
    #app{width:100%;height:100%;display:flex;flex-direction:column;background:white;}

    /* ‚úÖ Splash overlay */
    #splash{
      position:fixed; inset:0;
      background:linear-gradient(180deg, #0b1220, #111827);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
      transition:opacity .35s ease, transform .35s ease;
    }
    #splash.hidden{
      opacity:0;
      transform:scale(1.02);
      pointer-events:none;
    }
    .splash-card{display:flex; flex-direction:column; align-items:center; gap:14px;}
    .splash-logo{
      width:108px; height:108px;
      border-radius:28px;
      background:rgba(255,255,255,0.08);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      padding:12px;
    }
    .splash-title{
      font-weight:900;
      font-size:22px;
      background:linear-gradient(135deg,#06b6d4,#3b82f6);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      letter-spacing:.2px;
    }
    .splash-sub{
      color:rgba(255,255,255,.55);
      font-size:12px;
      font-weight:800;
      letter-spacing:1px;
      text-transform:uppercase;
    }

    .header{
      background:var(--dark);
      color:white;
      padding:env(safe-area-inset-top) 16px 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index:10;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .header-green{background:var(--success);}
    .header-blue{background:var(--primary);}
    .header-gray{background:var(--slate);}

    .content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;background:white;}

    /* ‚úÖ Header app-style iOS */
    .header-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:120px;
    }
    .header-logo{
      width:28px;
      height:28px;
      border-radius:9px;
      background:rgba(255,255,255,0.10);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:3px;
    }
    .header-logo img{
      width:100%;
      height:100%;
      object-fit:contain;
      transform:scale(1.05);
      display:block;
    }
    .header-title{
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:180px;
    }

    .logo-container{text-align:center;padding:26px 20px;background:var(--dark);}

    /* ‚úÖ Riquadro logo home: pi√π grande + aria + leggibile */
    .logo-icon{
      width:var(--logoBox);
      height:var(--logoBox);
      margin:0 auto 12px;
      border-radius:var(--logoRadius);
      background:rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      box-shadow:0 10px 25px rgba(0,0,0,0.25);
      padding:var(--logoPad);
    }

    .logo-img{
      width:100%;
      height:100%;
      object-fit:contain;        /* ‚úÖ mostra la scritta */
      transform:scale(var(--logoZoom)); /* ‚úÖ micro-crop per togliere bordi */
      display:block;
    }

    .logo-text{
      font-size:24px;
      font-weight:900;
      background:linear-gradient(135deg,#06b6d4,#3b82f6);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    .list-item{
      padding:18px 20px;
      border-bottom:1px solid #f0f0f0;
      display:flex;align-items:center;justify-content:space-between;
      transition:background 0.1s;
      cursor:pointer;
    }
    .list-item:active{background:#f9fafb;}

    .btn{
      padding:14px;border:none;border-radius:12px;
      font-size:15px;font-weight:800;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:transform 0.1s, opacity 0.2s;
      user-select:none;
    }
    .btn:active{transform:scale(0.96);}
    .btn-primary{background:var(--success);color:white;}
    .btn-danger{background:var(--danger);color:white;}
    .btn-outline{background:#e5e7eb;color:#374151;}
    .btn:disabled{opacity:0.4;cursor:not-allowed;transform:none!important;}

    .btn-mini{
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:900;
    }

    .display-box{padding:15px;text-align:center;position:relative;}
    .display-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;opacity:0.8;margin-bottom:4px;}
    .display-value{font-size:32px;font-weight:900;font-variant-numeric:tabular-nums;}

    .mode-selector{display:flex;background:#f3f4f6;padding:4px;gap:4px;}
    .mode-btn{
      flex:1;padding:10px;border:none;border-radius:8px;
      font-weight:900;font-size:12px;background:transparent;color:#6b7280;
      cursor:pointer;
    }
    .mode-btn.active{background:white;color:var(--primary);box-shadow:0 2px 4px rgba(0,0,0,0.1);}

    .field-selector{display:flex;gap:8px;padding:10px;justify-content:center;background:#4b5563; align-items:center;}
    .field-btn{
      padding:8px 16px;border:none;border-radius:20px;
      background:rgba(255,255,255,0.2);color:white;font-size:11px;font-weight:900;
      cursor:pointer;
    }
    .field-btn.active{background:white;color:#374151;}

    .machine-row{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      padding-top:8px;
    }

    .keypad{
      display:grid;grid-template-columns:repeat(3,1fr);
      gap:10px;padding:15px;background:#f9fafb;
    }
    .key{
      height:60px;border:none;border-radius:14px;
      font-size:22px;font-weight:900;background:white;
      box-shadow:0 2px 4px rgba(0,0,0,0.05);
      color:var(--dark);
      cursor:pointer;
      transition:transform .1s, background .1s, opacity .2s;
      user-select:none;
    }
    .key:active{background:#e2e8f0;transform:scale(0.95);}
    .key.action{background:#fee2e2;color:var(--danger);}

    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;
      font-size:11px;font-weight:900;
    }

    .info-card{
      margin:20px;padding:26px 20px;
      background:var(--dark);color:white;
      border-radius:20px;text-align:center;
      box-shadow:0 10px 25px rgba(0,0,0,0.2);
    }
    .dev-badge{
      display:inline-block;padding:6px 15px;
      background:rgba(255,255,255,0.1);border-radius:30px;
      font-size:12px;font-weight:900;color:#06b6d4;margin-bottom:15px;
    }

    /* Responsive automatico per altezza */
    @media (max-height: 720px){
      :root{ --logoBox: 100px; --logoRadius: 24px; --logoPad: 9px; --logoZoom: 1.10; }
      .logo-container{padding:18px 15px;}
      .keypad{gap:8px;padding:12px;}
      .key{height:50px;font-size:20px;border-radius:12px;}
      .btn{padding:12px;font-size:14px;}
      .display-box{padding:12px;}
      .display-value{font-size:26px;}
      .header{padding-bottom:12px;}
    }
    @media (max-height: 640px){
      :root{ --logoBox: 94px; --logoRadius: 22px; --logoPad: 8px; --logoZoom: 1.08; }
      .key{height:44px;font-size:18px;}
      .display-value{font-size:24px;}
      .btn{padding:10px;font-size:13px;}
      .btn-mini{padding:7px 9px;font-size:11px;}
    }
  </style>
</head>

<body>
  <!-- ‚úÖ Splash Screen -->
  <div id="splash">
    <div class="splash-card">
      <div class="splash-logo">
        <img src="./assets/moneytrack-logo.png" alt="MoneyTrack" style="width:100%;height:100%;object-fit:contain;transform:scale(1.08);display:block;">
      </div>
      <div class="splash-title">MoneyTrack</div>
      <div class="splash-sub">Loading‚Ä¶</div>
    </div>
  </div>

  <div id="app"></div>

  <script>
    // ‚úÖ Percorsi (GitHub Pages safe)
    const LOGO_SRC = "./assets/moneytrack-logo.png";

    const banks = ['Euronet','Chianti Banca','CCB','CRV','Medio Banca','MPS','MPS PG','Intesa S.Paolo'];
    const employees = ['Francesco','Silvia','Dorota','William','Stefania','Filomena','Valeria','Flavio','Ciro','Alessandro','Ida'];

    const STORAGE_KEY = "moneytrack_pro_v3";

    let state = {
      screen: 'banks',
      selectedBank: '',
      selectedEmployee: '',
      amount: '0',
      rejected: '0',
      mode: 'manual',
      inputField: 'amount',
      totals: {},
      lastMachineValue: {},
      machineConfirmed: {},
      lastOp: null,
      logs: []
    };

    // ========= HAPTIC / VIBRATION =========
    function haptic(type = "tap"){
      // iOS Safari spesso non supporta vibrate: qui non succede nulla, ma non rompe.
      if (!("vibrate" in navigator)) return;

      // pattern leggeri
      const patterns = {
        tap: 8,
        key: 6,
        nav: 10,
        success: [14, 20, 10],
        warn: [20, 30, 20],
        error: [30, 40, 30]
      };
      try{
        navigator.vibrate(patterns[type] ?? patterns.tap);
      }catch(e){}
    }

    function getKey(bank, emp){ return `${bank}|||${emp}`; }

    function formatEUR(n){
      return new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' }).format(Number(n)||0);
    }

    function safeParse(v){
      const s = (v ?? "0").toString();
      if (s === "." || s === "") return 0;
      if (s.endsWith(".")) return parseFloat(s.slice(0,-1)) || 0;
      const val = parseFloat(s);
      return isNaN(val) ? 0 : val;
    }

    function save(){
      const data = {
        totals: state.totals,
        lastMachineValue: state.lastMachineValue,
        machineConfirmed: state.machineConfirmed,
        logs: state.logs,
        lastOp: state.lastOp
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        state.totals = parsed.totals || {};
        state.lastMachineValue = parsed.lastMachineValue || {};
        state.machineConfirmed = parsed.machineConfirmed || {};
        state.logs = parsed.logs || [];
        state.lastOp = parsed.lastOp || null;
      }catch(e){
        state.totals = {};
        state.lastMachineValue = {};
        state.machineConfirmed = {};
        state.logs = [];
        state.lastOp = null;
      }
    }

    function pushLog(delta, kind, meta = {}){
      state.logs = state.logs || [];
      state.logs.push({
        ts: new Date().toISOString(),
        bank: state.selectedBank,
        emp: state.selectedEmployee,
        delta: Number(delta) || 0,
        kind,
        ...meta
      });
    }

    function startOfTodayLocal(){
      const d = new Date();
      d.setHours(0,0,0,0);
      return d.getTime();
    }

    function computeTodayStats(){
      const start = startOfTodayLocal();
      let totalToday = 0;
      const byBank = {};
      const byEmp = {};

      for(const e of (state.logs||[])){
        const t = new Date(e.ts).getTime();
        if(isNaN(t) || t < start) continue;
        const delta = Number(e.delta) || 0;
        totalToday += delta;
        byBank[e.bank] = (byBank[e.bank] || 0) + delta;
        byEmp[e.emp] = (byEmp[e.emp] || 0) + delta;
      }

      let topEmp = null;
      let topVal = -Infinity;
      for(const [emp,val] of Object.entries(byEmp)){
        if(val > topVal){ topVal = val; topEmp = emp; }
      }
      return { totalToday, byBank, byEmp, topEmp, topVal: topVal === -Infinity ? 0 : topVal };
    }

    // ========= EXPORT =========
    function todayLabel(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function exportTodayCSV(){
      const s = computeTodayStats();
      const date = todayLabel();

      const lines = [];
      lines.push(["Data","Sezione","Nome","Valore"].join(","));

      lines.push([date,"TOTALE_GIORNALIERO","", (s.totalToday||0).toFixed(2)].join(","));

      // per banca
      for(const [bank,val] of Object.entries(s.byBank).sort((a,b)=>b[1]-a[1])){
        lines.push([date,"BANCA", `"${bank.replace(/"/g,'""')}"`, (val||0).toFixed(2)].join(","));
      }

      // per dipendente
      for(const [emp,val] of Object.entries(s.byEmp).sort((a,b)=>b[1]-a[1])){
        lines.push([date,"DIPENDENTE", `"${emp.replace(/"/g,'""')}"`, (val||0).toFixed(2)].join(","));
      }

      const csv = lines.join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `moneytrack-${date}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
      haptic("success");
    }

    function exportTodayPDF(){
      const s = computeTodayStats();
      const date = todayLabel();

      const banksRows = Object.entries(s.byBank).sort((a,b)=>b[1]-a[1])
        .map(([bank,val]) => `<tr><td>${escapeHtml(bank)}</td><td style="text-align:right;font-weight:800;">${formatEUR(val)}</td></tr>`).join("");

      const empRows = Object.entries(s.byEmp).sort((a,b)=>b[1]-a[1])
        .map(([emp,val]) => `<tr><td>${escapeHtml(emp)}</td><td style="text-align:right;font-weight:800;">${formatEUR(val)}</td></tr>`).join("");

      const topText = s.topEmp ? `${escapeHtml(s.topEmp)} ‚Äî ${formatEUR(s.topVal)}` : "Nessun movimento";

      const w = window.open("", "_blank");
      if(!w){ alert("Popup bloccato: abilita i popup per esportare in PDF."); return; }

      w.document.write(`
        <html lang="it">
        <head>
          <meta charset="UTF-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1.0" />
          <title>MoneyTrack Report ${date}</title>
          <style>
            body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; padding:24px; color:#111827;}
            .top{display:flex; align-items:center; gap:14px; margin-bottom:18px;}
            .logo{width:54px;height:54px;border-radius:14px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden;padding:6px;}
            .logo img{width:100%;height:100%;object-fit:contain;transform:scale(1.08);}
            h1{font-size:20px;margin:0;}
            .muted{color:#6b7280;font-weight:700;font-size:12px;margin-top:4px;}
            .card{border:1px solid #e5e7eb;border-radius:14px;padding:14px;margin:14px 0;}
            .big{font-size:22px;font-weight:900;}
            table{width:100%;border-collapse:collapse;}
            td{padding:10px 6px;border-bottom:1px solid #f3f4f6;}
            .section{font-weight:900;margin-top:10px;}
            @media print { .no-print{display:none;} body{padding:0;} }
          </style>
        </head>
        <body>
          <div class="top">
            <div class="logo"><img src="${LOGO_SRC}" alt="MoneyTrack"></div>
            <div>
              <h1>MoneyTrack ‚Äî Report Giornaliero</h1>
              <div class="muted">Data: ${date}</div>
            </div>
          </div>

          <div class="card">
            <div class="section">Totale giornaliero</div>
            <div class="big">${formatEUR(s.totalToday)}</div>
          </div>

          <div class="card">
            <div class="section">Chi ha contato di pi√π üëÄ</div>
            <div style="font-weight:900; font-size:16px; margin-top:6px;">${topText}</div>
          </div>

          <div class="card">
            <div class="section">Totale per banca</div>
            <table>${banksRows || "<tr><td colspan='2' style='color:#6b7280;'>Nessun dato</td></tr>"}</table>
          </div>

          <div class="card">
            <div class="section">Totale per dipendente</div>
            <table>${empRows || "<tr><td colspan='2' style='color:#6b7280;'>Nessun dato</td></tr>"}</table>
          </div>

          <button class="no-print" onclick="window.print()" style="margin-top:10px;padding:12px 14px;border:none;border-radius:12px;background:#2563eb;color:white;font-weight:900;cursor:pointer;">
            Stampa / Salva come PDF
          </button>
        </body>
        </html>
      `);

      w.document.close();
      haptic("success");
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    // ========= Keypad =========
    function addDigit(d){
      haptic("key");
      const f = state.inputField;
      let cur = state[f];
      if(cur === '0') state[f] = d;
      else if(cur.length < 10) state[f] = cur + d;
      render();
    }
    function addDecimal(){
      haptic("key");
      const f = state.inputField;
      if(!state[f].includes('.')) state[f] += '.';
      render();
    }
    function deleteDigit(){
      haptic("tap");
      const f = state.inputField;
      let cur = state[f];
      state[f] = (cur.length > 1) ? cur.slice(0,-1) : '0';
      if(state[f] === '-') state[f] = '0';
      render();
    }
    function clearInput(){
      haptic("tap");
      state[state.inputField] = '0';
      render();
    }

    // ========= Core actions =========
    function setMode(mode){
      haptic("nav");
      state.mode = mode;
      state.amount = '0';
      state.rejected = '0';
      state.inputField = 'amount';
      render();
    }
    function setInputField(field){
      haptic("tap");
      state.inputField = field;
      render();
    }

    // ‚úÖ Valore iniziale: imposta manualmente il totale del dipendente
    function setInitialValue(){
      const key = getKey(state.selectedBank, state.selectedEmployee);
      const current = state.totals[key] || 0;

      const raw = prompt("Inserisci il VALORE INIZIALE per questo dipendente (es. 1234.56):", String(current.toFixed(2)));
      if(raw === null) return;

      const v = safeParse(raw.replace(",", "."));
      if(v < 0){
        haptic("error");
        alert("Valore non valido.");
        return;
      }

      const delta = v - current;
      state.totals[key] = v;

      state.lastOp = {
        key,
        delta, // per undo
        bank: state.selectedBank,
        prevMachine: state.lastMachineValue[state.selectedBank] || 0,
        type: 'init'
      };

      // logga solo la differenza per le statistiche
      if(delta !== 0){
        pushLog(delta, "init", { note: "Valore iniziale" });
      }

      save();
      haptic("success");
      render();
    }

    function confirmMachineValue(){
      if(state.mode !== 'auto') return;

      const key = getKey(state.selectedBank, state.selectedEmployee);
      const currentTotal = state.totals[key] || 0;

      const currentMachineValue = safeParse(state.amount);
      if(currentMachineValue <= 0){
        haptic("warn");
        return;
      }

      const lastValue = state.lastMachineValue[state.selectedBank] || 0;
      const delta = currentMachineValue - lastValue;

      state.totals[key] = currentTotal + delta;

      state.lastOp = {
        key,
        delta,
        bank: state.selectedBank,
        prevMachine: lastValue,
        newMachine: currentMachineValue,
        type: 'machine'
      };

      state.lastMachineValue[state.selectedBank] = currentMachineValue;
      state.machineConfirmed[state.selectedBank] = true;

      pushLog(delta, "machine");

      state.amount = '0';
      state.rejected = '0';
      state.inputField = 'rejected';

      save();
      haptic("success");
      render();
    }

    function addToTotal(){
      const key = getKey(state.selectedBank, state.selectedEmployee);
      const currentTotal = state.totals[key] || 0;
      let add = 0;

      if(state.mode === 'manual'){
        add = safeParse(state.amount);
        state.lastOp = {
          key,
          delta: add,
          bank: state.selectedBank,
          prevMachine: state.lastMachineValue[state.selectedBank] || 0,
          type: 'manual'
        };
      } else {
        if(state.machineConfirmed[state.selectedBank] !== true){
          haptic("warn");
          return;
        }

        const lastValue = state.lastMachineValue[state.selectedBank] || 0;
        const rejectedAmount = safeParse(state.rejected);

        if(state.inputField === 'rejected'){
          add = rejectedAmount;
          state.lastOp = {
            key,
            delta: add,
            bank: state.selectedBank,
            prevMachine: lastValue,
            type: 'rejected'
          };
        } else {
          const currentMachineValue = safeParse(state.amount);
          add = (currentMachineValue - lastValue) + rejectedAmount;

          state.lastOp = {
            key,
            delta: add,
            bank: state.selectedBank,
            prevMachine: lastValue,
            newMachine: currentMachineValue,
            type: 'mixed'
          };

          state.lastMachineValue[state.selectedBank] = currentMachineValue;
          state.machineConfirmed[state.selectedBank] = true;
        }
      }

      state.totals[key] = currentTotal + add;
      pushLog(add, state.mode === 'manual' ? "manual" : "ok");

      state.amount = '0';
      state.rejected = '0';
      state.inputField = 'amount';

      save();
      haptic("success");
      render();
    }

    function undoLast(){
      const op = state.lastOp;
      if(!op || !op.key){
        haptic("warn");
        return;
      }

      const cur = state.totals[op.key] || 0;
      state.totals[op.key] = cur - (op.delta || 0);

      if(op.bank && op.prevMachine !== undefined){
        state.lastMachineValue[op.bank] = op.prevMachine || 0;
      }

      if(state.logs && state.logs.length){
        const last = state.logs[state.logs.length - 1];
        const same = last && last.bank === op.bank && last.emp && op.key === getKey(last.bank, last.emp);
        if(same) state.logs.pop();
      }

      state.lastOp = null;
      save();
      haptic("tap");
      render();
    }

    function resetTotal(){
      const key = getKey(state.selectedBank, state.selectedEmployee);
      if(!confirm("Reset totale dipendente?")) return;
      state.totals[key] = 0;
      state.amount = '0';
      state.rejected = '0';
      state.lastOp = null;
      save();
      haptic("error");
      render();
    }

    function resetMachine(){
      // reset ‚Äúforte‚Äù
      state.lastMachineValue[state.selectedBank] = 0;
      state.machineConfirmed[state.selectedBank] = false;
      state.amount = '0';
      state.rejected = '0';
      state.inputField = 'amount';
      state.lastOp = null;
      save();
      haptic("error");
      render();
    }

    function zeroMachineQuick(){
      // reset rapido (stesso effetto, ma senza toccare gli input se non vuoi)
      state.lastMachineValue[state.selectedBank] = 0;
      state.machineConfirmed[state.selectedBank] = false;
      save();
      haptic("error");
      render();
    }

    // ========= UI helpers =========
    function headerHTML(titleRightButtonsHTML, backHTML = ''){
      return `
        <div class="header">
          <div class="header-left">
            ${backHTML || ''}
            <div class="header-logo"><img src="${LOGO_SRC}" alt="MT"></div>
            <div class="header-title">MoneyTrack Pro</div>
          </div>
          <div style="display:flex; gap:10px">${titleRightButtonsHTML || ''}</div>
        </div>
      `;
    }

    function render(){
      const app = document.getElementById('app');

      if(state.screen === 'banks'){
        app.innerHTML = `
          ${headerHTML(`
            <button class="btn btn-mini" style="background:#374151; width:44px" onclick="haptic('nav'); state.screen='stats'; render()">üìä</button>
            <button class="btn btn-mini" style="background:#374151; width:44px" onclick="haptic('nav'); state.screen='info'; render()">‚ÑπÔ∏è</button>
          `)}

          <div class="logo-container">
            <div class="logo-icon">
              <img class="logo-img" src="${LOGO_SRC}" alt="MoneyTrack logo">
            </div>
            <div class="logo-text">MoneyTrack</div>
          </div>

          <div class="header header-green" style="padding:10px 16px; font-size:13px">
            SELEZIONA BANCA
          </div>

          <div class="content">
            ${banks.map(b => `
              <div class="list-item" onclick="haptic('nav'); state.selectedBank='${b}'; state.screen='employees'; render()">
                <span style="font-weight:900">${b}</span>
                <span style="color:#9ca3af">‚Ä∫</span>
              </div>
            `).join('')}
          </div>
        `;
        return;
      }

      if(state.screen === 'info'){
        app.innerHTML = `
          ${headerHTML('', `<button class="btn btn-mini" style="background:transparent; color:white; font-size:20px" onclick="haptic('nav'); state.screen='banks'; render()">‚Äπ</button>`)}
          <div class="content" style="background:var(--gray-bg)">
            <div class="info-card">
              <div class="logo-icon" style="margin:0 auto 18px;">
                <img class="logo-img" src="${LOGO_SRC}" alt="MoneyTrack logo">
              </div>

              <div class="dev-badge">DEVELOPER</div>
              <h1 style="font-size:28px; letter-spacing:1px; margin-bottom:5px">TESTI FRANCESCO</h1>
              <p style="opacity:0.6; font-size:14px">Software Engineer & Design</p>

              <div style="margin-top:26px; padding-top:18px; border-top:1px solid rgba(255,255,255,0.1); font-size:12px; opacity:0.4">
                MoneyTrack Pro v1.4.0<br>¬© 2024 Tutti i diritti riservati
              </div>
            </div>
          </div>
        `;
        return;
      }

      if(state.screen === 'stats'){
        const s = computeTodayStats();
        const topText = s.topEmp ? `${s.topEmp} ‚Äî ${formatEUR(s.topVal)}` : "Nessun movimento oggi";

        const rows = Object.entries(s.byBank)
          .sort((a,b)=>b[1]-a[1])
          .map(([bank,val]) => `
            <div class="list-item" style="cursor:default">
              <span style="font-weight:900">${bank}</span>
              <span style="font-weight:900; color:var(--success)">${formatEUR(val)}</span>
            </div>
          `).join('');

        app.innerHTML = `
          ${headerHTML(`
            <button class="btn btn-mini" style="background:#374151;" onclick="exportTodayCSV()">CSV</button>
            <button class="btn btn-mini" style="background:#374151;" onclick="exportTodayPDF()">PDF</button>
          `, `<button class="btn btn-mini" style="background:transparent; color:white; font-size:20px" onclick="haptic('nav'); state.screen='banks'; render()">‚Äπ</button>`)}

          <div class="content" style="background:#fff">
            <div class="display-box" style="background:var(--dark); color:white">
              <div class="display-label">Totale giornaliero</div>
              <div class="display-value">${formatEUR(s.totalToday)}</div>
            </div>

            <div class="display-box" style="background:var(--purple); color:white">
              <div class="display-label">Chi ha contato di pi√π üëÄ</div>
              <div style="font-size:18px; font-weight:900">${topText}</div>
            </div>

            <div style="padding:12px 16px; font-weight:900; color:var(--dark); background:#fff">
              Totale per banca (oggi)
            </div>

            ${rows || `<div style="padding:16px; color:#6b7280">Nessun dato per oggi.</div>`}

            <div style="padding:16px;">
              <button class="btn btn-outline" style="width:100%;" onclick="exportTodayCSV()">‚¨áÔ∏è Esporta CSV</button>
              <div style="height:10px;"></div>
              <button class="btn btn-outline" style="width:100%;" onclick="exportTodayPDF()">üñ®Ô∏è Esporta PDF</button>
            </div>
          </div>
        `;
        return;
      }

      if(state.screen === 'employees'){
        app.innerHTML = `
          <div class="header header-blue">
            <div class="header-left">
              <button class="btn btn-mini" style="background:transparent; color:white; font-size:20px" onclick="haptic('nav'); state.screen='banks'; render()">‚Äπ</button>
              <div class="header-logo"><img src="${LOGO_SRC}" alt="MT"></div>
              <div class="header-title">${state.selectedBank}</div>
            </div>
            <div style="display:flex; gap:10px">
              <button class="btn btn-mini" style="background:rgba(255,255,255,.18)" onclick="haptic('nav'); state.screen='stats'; render()">üìä</button>
            </div>
          </div>

          <div class="content">
            ${employees.map(e => {
              const total = state.totals[getKey(state.selectedBank, e)] || 0;
              return `
                <div class="list-item" onclick="haptic('nav'); state.selectedEmployee='${e}'; state.screen='counter'; state.amount='0'; state.rejected='0'; state.inputField='amount'; render()">
                  <span style="font-weight:800">${e}</span>
                  <span style="font-weight:900; color:var(--success)">${formatEUR(total)}</span>
                </div>
              `;
            }).join('')}
          </div>
        `;
        return;
      }

      if(state.screen === 'counter'){
        const key = getKey(state.selectedBank, state.selectedEmployee);
        const total = state.totals[key] || 0;

        const lastValue = state.lastMachineValue[state.selectedBank] || 0;
        const amountVal = safeParse(state.amount);
        const rejectedVal = safeParse(state.rejected);

        const okEnabled = (state.mode === 'manual') || (state.machineConfirmed[state.selectedBank] === true);

        const showConfirmMachine =
          state.mode === 'auto' &&
          state.inputField === 'amount' &&
          (amountVal > 0) &&
          (amountVal !== lastValue);

        const diff = (state.mode === 'auto') ? (amountVal - lastValue) : 0;
        const calc = (state.mode === 'auto') ? (diff + rejectedVal) : 0;

        app.innerHTML = `
          <div class="header header-gray">
            <div class="header-left">
              <button class="btn btn-mini" style="background:transparent; color:white; font-size:20px" onclick="haptic('nav'); state.screen='employees'; render()">‚Äπ</button>
              <div class="header-logo"><img src="${LOGO_SRC}" alt="MT"></div>
              <div class="header-title">${state.selectedEmployee}</div>
            </div>
            <div style="display:flex; gap:10px">
              <button class="btn btn-mini" style="background:rgba(255,255,255,.18)" onclick="setInitialValue()">INIZIO</button>
            </div>
          </div>

          <div class="mode-selector">
            <button class="mode-btn ${state.mode==='manual' ? 'active':''}" onclick="setMode('manual')">MANUALE</button>
            <button class="mode-btn ${state.mode==='auto' ? 'active':''}" onclick="setMode('auto')">AUTO DIFF</button>
          </div>

          <div class="content">
            <div class="display-box" style="background:var(--primary); color:white">
              <div class="display-label">Tot. dipendente</div>
              <div class="display-value">${formatEUR(total)}</div>
            </div>

            ${state.mode === 'auto' ? `
              <div style="background:#4b5563; color:white; padding:10px 12px; text-align:center;">
                <div style="font-size:12px; font-weight:900;">
                  Selezionatrice (ultimo): <span style="opacity:.95">${formatEUR(lastValue)}</span>
                </div>

                <div class="machine-row">
                  <button class="btn btn-mini" style="background:rgba(255,255,255,.18)" onclick="zeroMachineQuick()">AZZERA</button>
                  <span style="font-size:11px; font-weight:900; color:${state.machineConfirmed[state.selectedBank] ? '#86efac' : '#fbbf24'};">
                    ${state.machineConfirmed[state.selectedBank] ? '‚úî Confermato' : '‚ö† Conferma prima di OK'}
                  </span>
                </div>
              </div>

              <div class="field-selector">
                <button class="field-btn ${state.inputField==='amount'?'active':''}" onclick="setInputField('amount')">Valore Macchina</button>
                <button class="field-btn ${state.inputField==='rejected'?'active':''}" onclick="setInputField('rejected')">Scartate</button>
              </div>
            ` : ''}

            <div class="display-box" style="background:#f9fafb">
              <div class="display-label" style="color:#6b7280">
                ${state.mode === 'manual'
                  ? 'Inserimento'
                  : (state.inputField === 'amount' ? 'Valore macchina (attuale)' : 'Scartate')}
              </div>

              <div class="display-value" style="color:var(--dark)">
                ‚Ç¨ ${state.inputField === 'amount' ? state.amount : state.rejected}
              </div>

              ${state.mode === 'auto' && state.inputField === 'amount' && (state.amount !== '0' || state.rejected !== '0') ? `
                <div style="margin-top:8px; font-size:12px; font-weight:900;">
                  <span class="pill" style="background:#fde68a; color:#92400e">Diff: ${formatEUR(diff)}</span>
                  ${rejectedVal ? `<span class="pill" style="background:#fecaca; color:#991b1b; margin-left:8px">+ Scart: ${formatEUR(rejectedVal)}</span>` : ''}
                  <span class="pill" style="background:#bbf7d0; color:#065f46; margin-left:8px">= ${formatEUR(calc)}</span>
                </div>
              ` : ''}
            </div>

            ${showConfirmMachine ? `
              <div style="padding:0 15px 10px;">
                <button class="btn" style="width:100%; background:var(--cyan); color:white" onclick="confirmMachineValue()">
                  ‚úî CONFERMA VALORE MACCHINA
                </button>
              </div>
            ` : ''}

            <div class="keypad">
              ${[1,2,3,4,5,6,7,8,9].map(n => `<button class="key" onclick="addDigit('${n}')">${n}</button>`).join('')}
              <button class="key" onclick="addDecimal()">.</button>
              <button class="key" onclick="addDigit('0')">0</button>
              <button class="key action" onclick="deleteDigit()">‚å´</button>
            </div>

            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; padding:15px; background:#fff;">
              <button class="btn btn-outline" onclick="undoLast()">UNDO</button>
              <button class="btn btn-outline" onclick="clearInput()">CLEAR</button>
              <button class="btn btn-primary" ${okEnabled ? '' : 'disabled'} onclick="${okEnabled ? 'addToTotal()' : ''}">OK</button>
              <button class="btn btn-danger" onclick="resetTotal()">RESET</button>
            </div>

            ${state.mode === 'auto' ? `
              <div style="padding:0 15px 15px;">
                <button class="btn btn-outline" style="width:100%; background:var(--purple); color:white" onclick="resetMachine()">
                  RESET SELEZIONATRICE
                </button>
              </div>
            ` : ''}
          </div>
        `;
        return;
      }
    }

    // init
    load();
    render();

    // ‚úÖ Splash: 2 secondi poi fade out
    window.addEventListener('load', () => {
      const splash = document.getElementById('splash');
      setTimeout(() => {
        splash.classList.add('hidden');
        setTimeout(() => splash.remove(), 450);
      }, 2000);
    });

    // Previene lo zoom su double tap
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event){
      const now = Date.now();
      if(now - lastTouchEnd <= 300) event.preventDefault();
      lastTouchEnd = now;
    }, false);
  </script>
</body>
</html>